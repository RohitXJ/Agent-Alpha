<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Alpha - Private AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #171717; color: #e5e5e5; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #262626; }
        ::-webkit-scrollbar-thumb { background: #525252; border-radius: 8px; }
        .chat-bubble { max-width: 80%; border-radius: 1rem; padding: 0.75rem 1.25rem; margin-bottom: 0.5rem; word-wrap: break-word; }
        .chat-bubble-user { background-color: #3b82f6; color: white; align-self: flex-end; }
        .chat-bubble-ai { background-color: #374151; color: #f3f4f6; align-self: flex-start; }
        .chat-bubble-ai pre { background-color: #111827; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }
        .chat-bubble-ai table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        .chat-bubble-ai th, .chat-bubble-ai td { border: 1px solid #4b5563; padding: 8px; text-align: left; }
        .chat-bubble-ai th { background-color: #1f2937; }
        #message-input { resize: none; }
        #file-preview {
            max-height: 40px;
            max-width: 40px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        .form-container {
            display: flex;
            align-items: flex-end; /* Aligns items to the bottom */
            position: relative;
            background-color: #262626;
            border: 1px solid #404040;
            border-radius: 1.25rem;
            padding: 0.5rem;
        }
    </style>
</head>
<body class="bg-neutral-900">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-black text-neutral-200 w-64 flex-shrink-0 flex flex-col p-3 transition-all duration-300 ease-in-out">
            <div class="flex items-center justify-between p-2 mb-4">
                <h1 class="text-xl font-bold">Agent Alpha</h1>
                <button id="collapse-sidebar-button" class="p-1 rounded-full hover:bg-neutral-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
            </div>

            <nav class="flex flex-col space-y-1 mt-4">
                <button id="new-chat-button" class="w-full flex items-center text-left p-2 rounded-lg text-white bg-neutral-700 font-semibold hover:bg-neutral-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                    <span>New Chat</span>
                </button>
            </nav>
            <div class="flex-grow mt-6">
                 <div class="flex items-center p-2 text-sm text-neutral-500 font-semibold opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>History (Soon)</span>
                </div>
                <div id="chat-history-placeholder" class="overflow-y-auto mt-2 space-y-1 pr-1"></div>
            </div>

            <div class="flex-grow"></div>

            <div class="border-t border-neutral-700 p-2">
                 <p class="text-xs text-center text-neutral-500">Your Private AI Assistant</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-neutral-900 h-screen border-l border-black">
            <header class="flex items-center p-4 h-16 flex-shrink-0">
                <button id="expand-sidebar-button" class="p-2 rounded-full hover:bg-neutral-800 hidden">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </header>
             <div id="chat-window" class="w-full max-w-4xl mx-auto flex-grow flex flex-col p-4 overflow-hidden">
                <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center">
                    <h2 class="text-3xl font-bold text-neutral-400">Welcome to Agent Alpha</h2>
                    <p class="text-neutral-500 mt-2">Your private AI assistant. How can I help you today?</p>
                </div>
                <div id="chat-log" class="flex-grow flex flex-col space-y-4 overflow-y-auto pr-2"></div>
            </div>

            <div class="w-full max-w-4xl mx-auto p-4 pt-2 flex-shrink-0">
                <div id="chat-error" class="hidden mb-2 p-3 bg-red-500/20 text-red-300 rounded-lg text-sm"></div>
                <div id="file-upload-preview-container" class="hidden items-center bg-neutral-800 border border-neutral-700 rounded-t-2xl p-2 space-x-3">
                    <img id="file-preview" src="#" alt="File preview" class="hidden" />
                    <div id="file-icon" class="hidden w-10 h-10 flex items-center justify-center bg-neutral-700 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </div>
                    <span id="file-name" class="text-sm text-neutral-300 truncate"></span>
                    <button id="remove-file-button" class="ml-auto p-1 text-neutral-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <form id="chat-form">
                    <div class="form-container">
                        <input type="file" id="file-input" name="file" class="hidden">
                        <label for="file-input" class="p-2 text-neutral-400 hover:text-neutral-200 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                        </label>
                        <textarea id="message-input" placeholder="Ask anything, or paste a file..." class="flex-grow bg-transparent focus:outline-none text-neutral-200 p-2" rows="1"></textarea>
                        <button type="submit" id="submit-button" class="p-2 text-neutral-400 hover:bg-neutral-600 rounded-lg disabled:opacity-50" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Element Selection ---
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const submitButton = document.getElementById('submit-button');
        const chatLog = document.getElementById('chat-log');
        const emptyState = document.getElementById('empty-state');
        const newChatButton = document.getElementById('new-chat-button');
        const chatError = document.getElementById('chat-error');
        const sidebar = document.getElementById('sidebar');
        const collapseSidebarButton = document.getElementById('collapse-sidebar-button');
        const expandSidebarButton = document.getElementById('expand-sidebar-button');
        const fileUploadPreviewContainer = document.getElementById('file-upload-preview-container');
        const filePreview = document.getElementById('file-preview');
        const fileIcon = document.getElementById('file-icon');
        const fileName = document.getElementById('file-name');
        const removeFileButton = document.getElementById('remove-file-button');

        let sessionId = null;

        // --- Sidebar Toggle Logic ---
        collapseSidebarButton.addEventListener('click', () => {
            sidebar.classList.add('hidden');
            expandSidebarButton.classList.remove('hidden');
        });
        expandSidebarButton.addEventListener('click', () => {
            sidebar.classList.remove('hidden');
            expandSidebarButton.classList.add('hidden');
        });

        // --- Session Management ---
        const startNewSession = () => {
            sessionId = `session_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
            chatLog.innerHTML = '';
            emptyState.classList.remove('hidden');
            hideError();
            console.log(`New session started: ${sessionId}`);
        };

        // --- Helper Functions ---
        const updateSubmitButtonState = () => {
            const hasMessage = messageInput.value.trim() !== '';
            const hasFile = fileInput.files.length > 0;
            submitButton.disabled = !hasMessage && !hasFile;
        };
        const showError = (message) => { chatError.textContent = message; chatError.classList.remove('hidden'); };
        const hideError = () => { chatError.classList.add('hidden'); };
        const autoGrowTextarea = (element) => {
            element.style.height = "auto";
            element.style.height = (element.scrollHeight) + "px";
        };

        function createChatBubble(message, file, type) {
            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = `flex flex-col ${type === 'user' ? 'items-end' : 'items-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;

            if (message === '...') {
                bubble.innerHTML = '<div class="flex items-center space-x-1"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div></div>';
            } else {
                if (message) {
                    const messageText = document.createElement('div');
                    messageText.innerHTML = type === 'ai' ? marked.parse(message) : message;
                    bubble.appendChild(messageText);
                }
                if (file) {
                    const fileInfo = document.createElement('p');
                    fileInfo.className = 'text-xs opacity-75 mt-1';
                    fileInfo.textContent = `Attached file: ${file.name}`;
                    bubble.appendChild(fileInfo);
                }
            }
            
            bubbleWrapper.appendChild(bubble);
            chatLog.appendChild(bubbleWrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
            return bubbleWrapper;
        }

        function handleFileSelect(file) {
            if (!file) return;
            
            fileInput.files = new DataTransfer().files;
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            fileName.textContent = file.name;
            filePreview.classList.add('hidden');
            fileIcon.classList.add('hidden');

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    filePreview.src = e.target.result;
                    filePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                fileIcon.classList.remove('hidden');
            }
            fileUploadPreviewContainer.classList.remove('hidden');
            fileUploadPreviewContainer.classList.add('flex');
            
            const formTextareaContainer = document.querySelector('#chat-form .form-container');
            formTextareaContainer.classList.remove('rounded-2xl');
            formTextareaContainer.classList.add('rounded-b-2xl');
            
            updateSubmitButtonState();
        }

        fileInput.addEventListener('change', () => handleFileSelect(fileInput.files[0]));

        removeFileButton.addEventListener('click', () => {
            fileInput.value = '';
            fileUploadPreviewContainer.classList.add('hidden');
            fileUploadPreviewContainer.classList.remove('flex');
            const formTextareaContainer = document.querySelector('#chat-form .form-container');
            formTextareaContainer.classList.add('rounded-2xl');
            formTextareaContainer.classList.remove('rounded-b-2xl');
            updateSubmitButtonState();
        });

        messageInput.addEventListener('paste', (e) => {
            if (e.clipboardData.files.length > 0) {
                e.preventDefault();
                handleFileSelect(e.clipboardData.files[0]);
            }
        });

        const submitForm = async () => {
            const messageContent = messageInput.value.trim();
            const file = fileInput.files[0];
            if (!messageContent && !file) return;

            hideError();
            emptyState.classList.add('hidden');
            
            createChatBubble(messageContent, file, 'user');
            
            messageInput.value = '';
            autoGrowTextarea(messageInput);
            removeFileButton.click();
            updateSubmitButtonState();

            const typingBubble = createChatBubble('...', null, 'ai');

            const formData = new FormData();
            formData.append('message', messageContent);
            if (file) {
                formData.append('file', file);
            }
            formData.append('sessionId', sessionId);

            try {
                const response = await fetch("/api/chat", { method: 'POST', body: formData });
                typingBubble.remove();
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `HTTP error! Status: ${response.status}`);
                }
                
                let aiResponseText = result.response_from_n8n;
                if (typeof aiResponseText !== 'string') {
                    aiResponseText = JSON.stringify(aiResponseText, null, 2);
                }
                createChatBubble(aiResponseText, null, 'ai');

            } catch (error) {
                console.error('Fetch error:', error);
                const errorMessage = `Error: ${error.message}`;
                createChatBubble(errorMessage, null, 'ai');
                showError(errorMessage);
            }
        };
        
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            submitForm();
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitForm();
            }
        });
        
        newChatButton.addEventListener('click', startNewSession);

        messageInput.addEventListener('input', () => {
            updateSubmitButtonState();
            autoGrowTextarea(messageInput);
        });

        startNewSession();

    </script>
</body>
</html>
ut.addEventListener('input', () => {
            updateSubmitButtonState();
            autoGrowTextarea(messageInput);
        });

        // Start the first session on page load
        startNewSession();

    </script>
</body>
</html>
